#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.11"
# ///

import curses
from pathlib import Path

REPO_ROOT = Path(__file__).parent.resolve()
SKILLS_SOURCE_DIR = REPO_ROOT / "output_skills"
GLOBAL_SKILLS_DIR = Path.home() / ".claude" / "skills"


def discover_skills():
    if not SKILLS_SOURCE_DIR.exists():
        return []
    return sorted([d.name for d in SKILLS_SOURCE_DIR.iterdir() if d.is_dir()])


def is_installed(skill_name):
    source = SKILLS_SOURCE_DIR / skill_name
    target = GLOBAL_SKILLS_DIR / skill_name
    return target.is_symlink() and target.resolve() == source


def install_skill(skill_name):
    source = SKILLS_SOURCE_DIR / skill_name
    target = GLOBAL_SKILLS_DIR / skill_name

    if target.exists() or target.is_symlink():
        if target.is_symlink():
            target.unlink()
        else:
            return

    GLOBAL_SKILLS_DIR.mkdir(parents=True, exist_ok=True)
    target.symlink_to(source)


def uninstall_skill(skill_name):
    target = GLOBAL_SKILLS_DIR / skill_name
    if target.is_symlink():
        target.unlink()


def main(stdscr):
    curses.curs_set(0)
    curses.use_default_colors()

    skills = discover_skills()

    if not skills:
        stdscr.addstr(0, 0, "No skills found in output_skills/. Press any key to exit.")
        stdscr.getch()
        return

    selected = 0

    while True:
        stdscr.clear()
        stdscr.addstr(0, 0, "Skills Manager")
        stdscr.addstr(1, 0, "─" * 40)

        for i, name in enumerate(skills):
            installed = is_installed(name)
            checkbox = "[x]" if installed else "[ ]"
            prefix = "→ " if i == selected else "  "
            line = f"{prefix}{checkbox} {name}"
            stdscr.addstr(i + 3, 0, line)

        stdscr.addstr(len(skills) + 5, 0, "↑↓ navigate | SPACE toggle | q quit")
        stdscr.refresh()

        key = stdscr.getch()

        if key == ord("q"):
            break
        elif key == curses.KEY_UP and selected > 0:
            selected -= 1
        elif key == curses.KEY_DOWN and selected < len(skills) - 1:
            selected += 1
        elif key == ord(" "):
            name = skills[selected]
            if is_installed(name):
                uninstall_skill(name)
            else:
                install_skill(name)


if __name__ == "__main__":
    curses.wrapper(main)
